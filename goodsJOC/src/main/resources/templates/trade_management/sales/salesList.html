<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="@{layout/default}">
<th:block layout:fragment="customTitle">
	<title>매입출 관리</title>
</th:block>
<!-- 로케이션 제목 -->
<th:block layout:fragment="locationTitle">
</th:block>
<!-- 로케이션 위치 -->
<th:block layout:fragment="locationPlace">
	<a id="main" th:href="@{/main}" class="joc-text1"><b>MAIN</b></a>
      > 거래관리 > 매출 및 영수증
   </th:block>

<!-- 메인 컨텐츠 영역 -->
<th:block layout:fragment="customContents">
	<!-- 주문 검색,등록버튼 -->
	<div class="card card-warning">
		<div class="card-header">
			<h3 class="card-title">
				<b>매출정보조회</b>
			</h3>
		</div>
		<div class="card-body table-responsive">
			<form th:action="@{/trade_management/purchase/searchPurchaseList}" method="post">
				<div class="tab-content row" id="custom-tabs-two-tabContent">
					<div class="col-10">
						<div class="form-group row">
							<label class="col-sm-1 col-form-label">담당자</label>
							<div class="col-sm-3">
								<div class="input-group mb-2">
									<input type="text" id="staffNameInput" class="form-control text-center" readonly>
									<div style="display:none">
										<label>직원 아이디</label>
										<div class="col-sm-10">
											<input type="text" class="form-control" name="id" id="staffIdInput">
										</div>
									</div>
									<div class="input-group-append">
										<button type="button" id="searchStaffBtn" class="btn btn-default" data-toggle="modal" data-target="#staffModal">
											<i class="fas fa-search"></i>
										</button>
									</div>
								</div>
							</div>
							
							<div class="col-sm-1"></div>
							
							<label class="col-sm-1 col-form-label">판매금액</label>
							
							<div class="col-sm-2">
								<input name="minPrice" type="number" class="form-control text-center" value=0>
							</div>
							<div class="col-sm-1 text-center">
								<b>~</b>
							</div>	
							<div class="col-sm-2">
								<input name="maxPrice" type="number" class="form-control text-center" value=0>
							</div>
						</div>
						<div class="form-group row">
							<label class="col-sm-1 col-form-label">취소여부</label>
							<div class="col-sm-3">
								<select name="state" class="form-control text-center">
									<option value="">전체보기</option>
									<option value="1">정상판매</option>
									<option value="2">판매취소</option>
								</select>
							</div>
							
							<div class="col-sm-1"></div>
							
							<label class="col-sm-1 col-form-label">거래일시</label>
							<div class="col-sm-2">
								<input name="startDate" type="date" class="form-control text-center">
							</div>
							<div class="col-sm-1 text-center">
								<b>~</b>
							</div>	
							<div class="col-sm-2">
								<input name="endDate" type="date" class="form-control text-center">
							</div>
							
						</div>
						<div class="form-group row" style="margin-bottom: -10px;">
							
							<label class="col-sm-1 col-form-label">주문번호</label>
							<div class="col-sm-3">
								<input type="number" name="orderNum" class="form-control text-center">
							</div>
							
							<div class="col-sm-2"></div>
							
							<div class="col-sm-2">
								<button type="submit" class="btn btn-block bg-gradient-warning btn-lg"><b>검색</b></button>
							</div>
							<div class="col-sm-1">
								<a th:href="@{/product_management/goods/goodsList}" type="button" class="btn btn-block bg-gradient-warning btn-lg">
									<i class="fas fa-redo-alt"></i>
								</a>
							</div>
							<div class="col-sm-2">
								<button type="button" class="btn btn-block bg-gradient-info btn-lg"><b>판매등록</b></button>
							</div>
						</div>
					</div>
					<div class="col-2" align="center" style="margin-bottom: -20px; margin-top: -5px;">
						<th:block th:if="${not #lists.isEmpty(salesTotalInfo)}" th:each="l : ${salesTotalInfo}">
							<div class="info-box mb-3 bg-info">
								<span class="info-box-icon bg-teal disabled color-palette elevation-1">
									<i class="fas fa-shopping-cart"></i>
								</span>
								<div class="info-box-content">
									<span class="info-box-text"> <b class="nowMonth"></b> 월 판매 건수</span> 
									<span class="info-box-number"> <b th:text="${l.salesCnt}"></b> 건</span>
								</div>
								<!-- /.info-box-content -->
							</div>
							<div class="info-box mb-3 bg-info" style="margin-top: -10px;">
								<span class="info-box-icon bg-teal elevation-1">
									<i class="fas fa-won-sign"></i>
								</span>
								<div class="info-box-content">
									<span class="info-box-text"> <b class="nowMonth"></b> 월 총매출금</span> 
									<span class="info-box-number"> <b class="money" th:text="${l.salesSumPrice}"></b></span>
								</div>
							</div>
						</th:block>
					</div>
				</div>
			</form>
		</div>
	</div>

<<<<<<< HEAD
	<!-------------------매출 조회 폼--------------------->
	<div class="col-12">
		<div class="card card-warning card-tabs">
			<div class="card-header p-0 pt-1"></div>
			<!-- /.card-header -->
			<div class="card-body table-responsive p-0" style="height: 400px;">
				<div class="col-12">
					<table class="table table-hover text-center">
						<thead>
							<tr>
								<th>영수증번호</th>
								<th>거래일시</th>
								<th>판매금액</th>
								<th>담당자</th>
								<th>상세보기</th>
								<th>취소 여부</th>
								<th>취소 일시</th>
							</tr>
						</thead>
						<tbody>
							<tr th:if="${not #lists.isEmpty(salesList)}" th:each="l, i : ${salesList}">
								<td th:text="${l.receiptNum}"></td>
								<td th:text="${l.regDate}"></td>
								<td th:text="${l.salesTotalPrice}"></td>
								<td th:text="${l.user.getName()}"></td>
								<td>
									<button type="button" class="btn btn-outline-primary btn-xs receiptBtn" data-toggle="modal" data-target="#receiptModal"
											th:data-salesCode="${l.salesCode}" th:data-receiptNum="${l.receiptNum}" th:data-regDate="${l.regDate}">
											영수증
									</button>
								</td>
								<td style="color: red;" th:text="${l.canselCheck}"></td>
								<td th:text="${l.canselDate}"></td>
							
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
	
	<!--------------영수증 Modal-------------->
	<div id="print">
		<form th:action="@{/trade_management/sales/salesList}" method="post">
			<div class="modal fade" id="receiptModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
				<div class="modal-dialog modal-md">
					<div class="modal-content">
						<div class="modal-header bg-info">
							<h5 class="modal-title" id="SalesDetall">영수증</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<!-- 영수증 상세내역  -->
						<div class="modal-body">
							<div class="invoice p-3 mb-3">
								<!-- info row -->
								<div class="invoice-info">
									<div>
										<h3 class="text-center" >
										********** <span th:text="${session.SMARTINFO.martName}"></span> **********
										</h3>
										<div class="text-center" style="margin-bottom: 10px;">
											<div>교환/환불시 구매점에서 가능(결제카드지참)</div>
											<div>체크카드 취소 시 대금환급은 최대 7일소요</div>
										</div>
										<div class="row">
											<div class="col-6"style="margin-bottom: 20px;">
												<div>
													<b>대표자:</b><span> </span><span th:text="${session.SMARTINFO.partnerName}"></span>
												</div>
												<div>
													<b>사업자번호:</b><span> </span><span th:text="${session.SMARTINFO.registerNum}"></span>
												</div>
												<div>
													<b>매장연락처:</b><span> </span><span th:text="${session.SMARTINFO.callNum}"></span>
												</div>
												<div>
													<b>주소:</b><span> </span><span th:text="${session.SMARTINFO.address}"></span>
												</div>
											</div>
											<div class="row col-6 text-center">
												취소된거 표시할구역
											</div>
										</div>
										<div class="row">
											<div class="col-8">
												<h5><b>No.</b><span> </span><span id="receiptNumber"></span></h5>
											</div>
											<div class="col-4">
												<h6><span id="salesDate"></span></h6>
											</div>
										</div>
									</div>
								</div>
								<div>
								
								</div>
								
								<!-- 영수증 테이블-->
								<div class="row">
									<div class="col-15 table-responsive">
										<table class="table table-striped" style="text-align: center;">
											<thead style="text-align: center;">
												<tr>
													<th></th>
													<th>상품명</th>
													<th>단가</th>
													<th>수량</th>
													<th>금액</th>
												</tr>
											</thead>
											<tbody id="salesDetailTable">
											</tbody>
										</table>
									</div>
								</div>
								<!-- 영수증 하단  -->
								<div class="row">
									<div class="col-4">
										<div class="table-responsive">
											<table class="table">
												<tbody>
													<tr>
														<th>VAT :</th>
													</tr>
													<tr>
														<th>합계 :</th>
													</tr>
												</tbody>
											</table>
										</div>
									</div>
								</div>
								
							</div>
									<!-- 저장 & 프린트 버튼  -->
									<div class="no-print">
											<button type="button" value="인쇄하기" id="print" class="btn-sm btn-info float-right" 
													onclick="javascript:content_print();">
												<i class="fas fa-download">ㅤPrint</i>
											</button>
									</div>
						</div>
					</div>
				</div>
			</div>
		</form>
	</div>
</th:block>

<th:block layout:fragment="customJs">
	<script type="text/javascript"> 
		//모달 영역지정 프린트 
		function content_print(){
			   
		    var initBody = document.body.innerHTML;
		    window.onbeforeprint = function(){
		        document.body.innerHTML = document.getElementById('print').innerHTML;
		    }
		    window.onafterprint = function(){
		        document.body.innerHTML = initBody;
		    }
		    window.print();    
		}

		//제이쿼리
		$(function(){
			//영수증 버튼 클릭시 이벤트
			$(document).on('click', '.receiptBtn', function(){
				var salesCode = $(this).attr('data-salesCode');
				var receiptNum = $(this).attr('data-receiptNum');
				var regDate = $(this).attr('data-regDate');
				console.log(receiptNum)
				console.log(salesCode)
				console.log(regDate)
				$('#receiptNumber').text(receiptNum);
				$('#salesDate').text(regDate);
				
				//판매정보 가져오기
				var request = $.ajax({
					url: '/trade_management/sales/salesDetialInfo',
					method: 'POST',
					data: {'salesCode' : slaesCode},
					dataType: 'json'
				});
				request.done(function(data){
					console.log("매입: " + data);
					//판매정보 넣기
					var salesDetailTable = $('#salesDetailTable');
					var businessName = data.business.businessName;
					var regNum = data.business.registerNum;
					var partnerName = data.business.partnerName;
					var callNum = data.business.callNum;
					var businessAddr = data.business.address;
					//초기화
					salesDetailTable.empty();
					//값 담기
					salesDetailTable.append("<tr><td>" + businessName + "</td></tr>");
					salesDetailTable.append("<tr><td>" + regNum + "</td></tr>");
					salesDetailTable.append("<tr><td>" + partnerName + "</td></tr>");
					salesDetailTable.append("<tr><td>" + callNum + "</td></tr>");
					salesDetailTable.append("<tr><td>" + businessAddr + "</td></tr>");
					
				});
			});
			
			
			
			
		});
	</script>
</th:block>